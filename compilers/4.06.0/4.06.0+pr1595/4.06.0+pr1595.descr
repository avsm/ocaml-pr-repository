Backport 1550 (pattern-matching changes) into the 4.06 maintenance branch